{"remainingRequest":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\src\\views\\manage\\check\\index.vue?vue&type=style&index=0&id=45c2bb0a&scoped=true&lang=css","dependencies":[{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\src\\views\\manage\\check\\index.vue","mtime":1744685972525},{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\css-loader\\dist\\cjs.js","mtime":1762330399953},{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":1762330418934},{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\postcss-loader\\src\\index.js","mtime":1762330405156},{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1762330398085},{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\vue-loader\\lib\\index.js","mtime":1762330415853}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ci5kaWFsb2ctY29udGVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZ2FwOiAzMHB4Owp9Cgouc2NvcmUtc2VjdGlvbiB7CiAgICBmbGV4OiAxOwp9CgouaW1hZ2Utc2VjdGlvbiB7CiAgICBmbGV4OiAxOwp9Cgoucm9vbS1pbWFnZSB7CiAgICB3aWR0aDogMTAwJTsKICAgIG1heC1oZWlnaHQ6IDMwMHB4OwogICAgb2JqZWN0LWZpdDogY29udGFpbjsKICAgIGJvcmRlci1yYWRpdXM6IDRweDsKfQoKLnJhdGUtaXRlbSB7CiAgICBtYXJnaW46IDE1cHggMDsKICAgIGZvbnQtc2l6ZTogMTZweDsKfQo="},{"version":3,"sources":["index.vue"],"names":[],"mappings":";AAqQA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA","file":"index.vue","sourceRoot":"src/views/manage/check","sourcesContent":["<template>\r\n    <div class=\"router-container\">\r\n        <div class=\"container\">\r\n            <div class=\"inner_container\" v-loading=\"loading\">\r\n                <!-- 搜索筛选区域 -->\r\n                <el-form :inline=\"true\" ref=\"queryForm\" label-width=\"80px\">\r\n                    <el-form-item label=\"宿舍楼栋\">\r\n                        <!-- <el-cascader :options=\"bdOptions\" v-model=\"selectedNode\" @change=\"bdChange\"\r\n                            clearable></el-cascader> -->\r\n                        <el-cascader :options=\"bdOptions\" v-model=\"selectedNode\" @change=\"bdChange\"></el-cascader>\r\n                    </el-form-item>\r\n                    <el-form-item label=\"宿舍号\">\r\n                        <!-- <el-input v-model=\"listQuery.number\" placeholder=\"输入宿舍号\" clearable></el-input> -->\r\n                        <el-input v-model=\"listQuery.number\" @keyup.enter=\"handleSearch\"></el-input>\r\n                    </el-form-item>\r\n                    <el-form-item>\r\n                        <el-button type=\"primary\" @click=\"handleSearch\">查询</el-button>\r\n                        <el-button @click=\"resetQuery\">重置</el-button>\r\n                    </el-form-item>\r\n                </el-form>\r\n\r\n                <!-- 数据表格区域 -->\r\n                <el-table :data=\"tableData\" border height=\"700\">\r\n                    <el-table-column label=\"序号\" width=\"80\">\r\n                        <template slot-scope=\"scope\">\r\n                            {{ (listQuery.page - 1) * listQuery.rows + scope.$index + 1 }}\r\n                        </template>\r\n                    </el-table-column>\r\n                    <!-- <el-table-column prop=\"building.name\" label=\"所属宿舍楼\" show-overflow-tooltip></el-table-column> -->\r\n                    <el-table-column label=\"所属宿舍楼\" show-overflow-tooltip>\r\n                        <template slot-scope=\"{row}\">\r\n                            {{ buildingMap.get(row.building.id) || row.building.name }}\r\n                        </template>\r\n                    </el-table-column>\r\n                    <el-table-column prop=\"room.number\" label=\"宿舍号\" width=\"120\"></el-table-column>\r\n                    <el-table-column prop=\"ce_score\" label=\"综合评分\" width=\"280\">\r\n                        <template slot-scope=\"{row}\">\r\n                            <el-rate v-model=\"row.ce_score\" :max=\"10\" disabled :allow-half=\"true\" />\r\n                        </template>\r\n                    </el-table-column>\r\n                    <el-table-column prop=\"rated_at\" label=\"检查时间\" width=\"180\"></el-table-column>\r\n                    <el-table-column label=\"操作\" width=\"120\" fixed=\"right\">\r\n                        <template slot-scope=\"scope\">\r\n                            <el-button type=\"text\" @click=\"showDetail(scope.row)\">详情</el-button>\r\n                        </template>\r\n                    </el-table-column>\r\n                </el-table>\r\n\r\n                <!-- 分页组件 -->\r\n                <el-pagination :current-page.sync=\"listQuery.page\" :page-sizes=\"[10, 20, 30]\"\r\n                    :page-size.sync=\"listQuery.rows\" :total=\"total\" @size-change=\"handleSizeChange\"\r\n                    @current-change=\"handleCurrentChange\" layout=\"total, sizes, prev, pager, next, jumper\">\r\n                </el-pagination>\r\n\r\n                <!-- 评分详情弹窗 -->\r\n                <el-dialog :title=\"currentRoom\" :visible.sync=\"dialogVisible\" width=\"60%\">\r\n                    <div class=\"dialog-content\">\r\n                        <div class=\"score-section\">\r\n                            <!-- 复用原有评分组件 -->\r\n                            <div class=\"rate-item\" v-for=\"(score, key) in scoreLabels\" :key=\"key\">\r\n                                <span>{{ score.label }}：</span>\r\n                                <el-rate v-model=\"currentScores[key]\" :max=\"10\" disabled :allow-half=\"true\" show-score\r\n                                    text-color=\"#ff9900\" score-template=\"{value}分\" />\r\n                            </div>\r\n                        </div>\r\n                        <div class=\"image-section\">\r\n                            <h3>宿舍照片</h3>\r\n                            <img :src=\"currentImage\" alt=\"宿舍照片\" class=\"room-image\">\r\n                        </div>\r\n                    </div>\r\n                </el-dialog>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</template>\r\n\r\n<script>\r\n    import { list } from \"@/api/building\";\r\n    import { listRoomsWithScores, scoreByRid } from \"@/api/score\"; // 假设新增的接口listRoomsWithScores\r\n\r\n    export default {\r\n        data() {\r\n            return {\r\n                buildingMap: new Map(),\r\n                listQuery: {\r\n                    page: 1,\r\n                    rows: 10,\r\n                    buildingId: null,\r\n                    number: ''\r\n                },\r\n                tableData: [],\r\n                total: 0,\r\n                // 弹窗相关数据\r\n                dialogVisible: false,\r\n                currentScores: {},\r\n                currentImage: '',\r\n                scoreLabels: {\r\n                    global_score: { label: '整体环境' },\r\n                    building_score: { label: '建筑设施' },\r\n                    bed_score: { label: '床铺卧具' },\r\n                    indoor_score: { label: '室内用品' },\r\n                    ce_score: { label: '综合评分' }\r\n                },\r\n                // 楼栋选择相关\r\n                bdOptions: [],\r\n                selectedNode: []\r\n            }\r\n        },\r\n        computed: {\r\n            currentRoom() {\r\n                return this.currentScores.building && this.currentScores.room\r\n                    ? `${this.currentScores.building.name} - ${this.currentScores.room.number}`\r\n                    : '宿舍详情';\r\n            }\r\n        },\r\n        methods: {\r\n            // 获取宿舍列表数据\r\n            async fetchData() {\r\n                this.loading = true;\r\n                try {\r\n                    const res = await listRoomsWithScores(\r\n                        this.listQuery.page,\r\n                        this.listQuery.rows,\r\n                        this.listQuery.buildingId,\r\n                        this.listQuery.number\r\n                    );\r\n\r\n                    this.tableData = res.content;\r\n                    this.total = res.totalElements;\r\n\r\n                    console.log(this.tableData)\r\n\r\n                    // 同步分页状态（防止后端修正参数）\r\n                    this.listQuery.page = res.pageNumber;\r\n                    this.listQuery.rows = res.pageSize;\r\n                } catch (error) {\r\n                    console.error('数据加载失败:', error);\r\n                } finally {\r\n                    this.loading = false;\r\n                }\r\n                this.loading = false\r\n            },\r\n            // 显示详情弹窗\r\n            async showDetail(row) {\r\n\r\n                try {\r\n                    const res = await scoreByRid(row.room_id);\r\n                    const imgName = res.data[0].img_name;\r\n                    this.$set(row, 'img_name', imgName);\r\n\r\n                    this.currentScores = { ...row };\r\n                    this.currentImage = process.env.VUE_APP_IMG_PREFIX + imgName;\r\n                    this.dialogVisible = true;\r\n                } catch (error) {\r\n                    console.error(\"获取图片失败\",error)\r\n                }\r\n            },\r\n\r\n            // 分页相关方法\r\n            handleSizeChange(val) {\r\n                this.listQuery.rows = val;\r\n                this.fetchData();\r\n            },\r\n            handleCurrentChange(val) {\r\n                this.listQuery.page = val;\r\n                this.fetchData();\r\n            },\r\n            // 搜索相关\r\n            handleSearch() {\r\n                this.listQuery.page = 1;\r\n                this.fetchData();\r\n                console.log(this.listQuery.buildingId)\r\n            },\r\n            resetQuery() {\r\n                this.listQuery = {\r\n                    page: 1,\r\n                    rows: 10,\r\n                    buildingId: null,\r\n                    number: ''\r\n                };\r\n                this.selectedNode = [];\r\n                this.fetchData();\r\n            },\r\n            // 格式化数据\r\n            // formatData(list) {\r\n            //     return list.map(item => {\r\n            //         const node = {\r\n            //             value: item.id,\r\n            //             label: item.number || item.name\r\n            //         };\r\n            //         // 仅当存在子节点且为数组时，递归格式化子节点\r\n            //         if (Array.isArray(item.children) && item.children.length > 0) {\r\n            //             node.children = this.formatData(item.children);\r\n            //         }\r\n\r\n            //         return node;\r\n            //     });\r\n            // },\r\n            formatData(list) {\r\n                return list.map(item => ({\r\n                    value: item.id,\r\n                    label: item.name,\r\n                    children: item.children?.length ? this.formatData(item.children) : null\r\n                }))\r\n            },\r\n            // 楼栋选择相关方法（保持原有逻辑）\r\n            async bdChange(value) {\r\n                this.listQuery.buildingId = value?.length > 0 ? value[value.length - 1] : null\r\n                this.handleSearch()\r\n            },\r\n            async listData() {\r\n                this.loading = true\r\n                const { data } = await list()\r\n                console.log(this.formatData(data))\r\n                this.bdOptions = this.formatData(data)\r\n                this.buildPathMap(data)\r\n                this.loading = false\r\n            },\r\n            buildPathMap(nodes, parentPath = '') {\r\n                nodes.forEach(node => {\r\n                    const currentPath = parentPath ? `${parentPath}/${node.name}` : node.name\r\n                    this.buildingMap.set(node.id, currentPath)\r\n                    if (node.children?.length) {\r\n                        this.buildPathMap(node.children, currentPath)\r\n                    }\r\n                })\r\n            }\r\n        },\r\n        async created() {\r\n            await this.listData();\r\n            await this.fetchData();\r\n        }\r\n    }\r\n</script>\r\n\r\n<style scoped>\r\n    .dialog-content {\r\n        display: flex;\r\n        gap: 30px;\r\n    }\r\n\r\n    .score-section {\r\n        flex: 1;\r\n    }\r\n\r\n    .image-section {\r\n        flex: 1;\r\n    }\r\n\r\n    .room-image {\r\n        width: 100%;\r\n        max-height: 300px;\r\n        object-fit: contain;\r\n        border-radius: 4px;\r\n    }\r\n\r\n    .rate-item {\r\n        margin: 15px 0;\r\n        font-size: 16px;\r\n    }\r\n</style>"]}]}