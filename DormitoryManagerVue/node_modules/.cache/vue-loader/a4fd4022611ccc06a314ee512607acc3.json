{"remainingRequest":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\src\\views\\manage\\score\\index.vue?vue&type=style&index=0&id=40da246d&prod&scoped=true&lang=css","dependencies":[{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\src\\views\\manage\\score\\index.vue","mtime":1744002454912},{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\css-loader\\dist\\cjs.js","mtime":1762330399953},{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":1762330418934},{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\postcss-loader\\src\\index.js","mtime":1762330405156},{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1762330398085},{"path":"G:\\E\\学生宿舍信息管理系统\\xsxxpt\\DormitoryManagerVue\\node_modules\\vue-loader\\lib\\index.js","mtime":1762330415853}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ci50YWJsZSB7CiAgcGFkZGluZzogMTBweDsKICBkaXNwbGF5OiBmbGV4Owp9Cgouc2NvcmVfdGFibGUgewogIGZsZXg6IDE7CiAgbWFyZ2luLWxlZnQ6IDUlOwp9CgouaW1nX2JveCB7CiAgZmxleDogMgp9Cgoucm91dGVyLWNvbnRhaW5lciB7CiAgaGVpZ2h0OiAxMDAlOwp9Cgoucm9vbV9zZWxlY3RvciB7CiAgbWFyZ2luLWJvdHRvbTogOCU7Cn0KCi5lbC1yYXRlIHsKICBsaW5lLWhlaWdodDogMi41OwogIC8qIOmHjee9ruihjOmrmCAqLwogIHZlcnRpY2FsLWFsaWduOiBtaWRkbGU7CiAgLyog5Z6C55u05a+56b2QICovCn0KCi5lbC1idXR0b24gewogIG1hcmdpbi10b3A6IDUlOwp9CgovKiDpmpDol4/kuIrkvKDmjInpkq4gKi8KOjp2LWRlZXAgLmhpZGUtdXBsb2FkIC5lbC11cGxvYWQtLXBpY3R1cmUtY2FyZCB7CiAgZGlzcGxheTogbm9uZSAhaW1wb3J0YW50Owp9Cg=="},{"version":3,"sources":["index.vue"],"names":[],"mappings":";AAyPA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA","file":"index.vue","sourceRoot":"src/views/manage/score","sourcesContent":["<template>\r\n  <div class=\"router-container\">\r\n    <div class=\"container\">\r\n      <div class=\"inner_container\">\r\n        <div class=\"table\" v-loading=\"loading\">\r\n          <div class=\"score_table\">\r\n            <div class=\"room_selector\">\r\n              <div class=\"room_selector\">\r\n                <span>选择楼栋：</span>\r\n                <el-cascader :options=\"bdOptions\" v-model=\"selectedtNode\" @change=\"bdChange\"></el-cascader>\r\n              </div>\r\n              <div class=\"room_selector\">\r\n                <span>选择宿舍：</span>\r\n                <el-select v-model=\"roomValue\" clearable>\r\n                  <el-option v-for=\"item in roomOptions\" :key=\"item.value\" :label=\"item.label\" :value=\"item.value\">\r\n                  </el-option>\r\n                </el-select>\r\n              </div>\r\n\r\n            </div>\r\n            <el-form ref=\"scoreForm\" :model=\"formData\">\r\n              <el-form-item label=\"整体环境评分：\" prop=\"score.global\">\r\n                <el-input-number v-model=\"formData.score.global_score\" :min=\"0\" :max=\"10\" />\r\n              </el-form-item>\r\n              <el-form-item label=\"建筑设施评分：\" prop=\"score.building\">\r\n                <el-input-number v-model=\"formData.score.building_score\" :min=\"0\" :max=\"10\" />\r\n              </el-form-item>\r\n              <el-form-item label=\"床铺卧具评分：\" prop=\"score.bed\">\r\n                <el-input-number v-model=\"formData.score.bed_score\" :min=\"0\" :max=\"10\" />\r\n              </el-form-item>\r\n              <el-form-item label=\"室内用品评分：\" prop=\"score.indoor\">\r\n                <el-input-number v-model=\"formData.score.indoor_score\" :min=\"0\" :max=\"10\" />\r\n              </el-form-item>\r\n            </el-form>\r\n          </div>\r\n          <div class=\"img_box\">\r\n            <el-upload ref=\"upload\" action=\"#\" :file-list=\"formData.fileList\" :class=\"{ 'hide-upload': hideUpload }\"\r\n              list-type=\"picture-card\" :limit=\"limit\" :auto-upload=\"false\" :on-change=\"handleImgChange\" :on-remove=\"handleRemove\">\r\n              <i slot=\"default\" class=\"el-icon-plus\"></i>\r\n              <div slot=\"file\" slot-scope=\"{file}\">\r\n                <img class=\"el-upload-list__item-thumbnail\" :src=\"file.url\" alt=\"\">\r\n                <span class=\"el-upload-list__item-actions\">\r\n                  <span class=\"el-upload-list__item-preview\" @click=\"handlePictureCardPreview(file)\">\r\n                    <i class=\"el-icon-zoom-in\"></i>\r\n                  </span>\r\n                  <span v-if=\"!disabled\" class=\"el-upload-list__item-delete\" @click=\"handleDownload(file)\">\r\n                    <i class=\"el-icon-download\"></i>\r\n                  </span>\r\n                  <span v-if=\"!disabled\" class=\"el-upload-list__item-delete\" @click=\"handleRemove(file)\">\r\n                    <i class=\"el-icon-delete\"></i>\r\n                  </span>\r\n                </span>\r\n              </div>\r\n            </el-upload>\r\n            <el-dialog :visible.sync=\"dialogVisible\">\r\n              <img width=\"100%\" :src=\"dialogImageUrl\" alt=\"\">\r\n            </el-dialog>\r\n            <el-button v-has-permi=\"\" type=\"primary\" @click=\"submit\" v-has-permi=\"['score:saveOrUpdate']\">提交</el-button>\r\n            <el-button v-has-permi=\"\" type=\"warning\" @click=\"reset\">重置</el-button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\n  import { list } from \"@/api/building\";\r\n  import { listByBId, saveOrUpdate } from \"@/api/score\"\r\n\r\n  export default {\r\n    name: \"index\",\r\n    data() {\r\n      return {\r\n        loading: undefined,\r\n        // 宿舍列表\r\n        roomOptions: [],\r\n        roomValue: '',\r\n        // 三级菜单列表\r\n        selectedtNode: [],\r\n        bdOptions: [],\r\n        // 表单\r\n        formData: {\r\n          score: { global_score: 0, building_score: 0, bed_score: 0, indoor_score: 0 },\r\n          roomId: '',\r\n          fileList: []\r\n        },\r\n        // 图片上传\r\n        dialogImageUrl: '',\r\n        dialogVisible: false,\r\n        disabled: false,\r\n        hideUpload:false,\r\n        limit:1\r\n      };\r\n    },\r\n    methods: {\r\n      // 提交数据\r\n      submit() {\r\n        this.$refs.scoreForm.validate(async valid => {\r\n\r\n          const _this = this\r\n\r\n          if (!valid || !this.roomValue) {\r\n            this.$message.error('请填写完整表单并选择宿舍')\r\n            return\r\n          }\r\n\r\n          // 构建FormData\r\n          const formData = new FormData();\r\n          // 将 scores 转为 Blob 并指定 JSON 类型\r\n          const scoresBlob = new Blob(\r\n            [JSON.stringify(this.formData.score)],\r\n            { type: 'application/json' }\r\n          );\r\n          formData.append('score', scoresBlob);\r\n          formData.append('roomId', this.roomValue);\r\n\r\n          // 添加图片（仅限1张）\r\n          if (this.$refs.upload.uploadFiles.length > 0) {\r\n            const file = this.$refs.upload.uploadFiles[0].raw;\r\n            formData.append('file', file);\r\n          }\r\n\r\n          for (let [key, value] of formData.entries()) {\r\n            console.log(key, value); // 确认字段名是 \"score\" 且值是 JSON 字符串\r\n          }\r\n\r\n          saveOrUpdate(formData).then(res => {\r\n            if (res.statusCode === 200) {\r\n              this.$message({\r\n                message: res.msg,\r\n                type: 'success'\r\n              });\r\n            }\r\n          })\r\n          _this.listData()\r\n          _this.reset()\r\n        })\r\n      },\r\n      // 重置表单\r\n      reset() {\r\n        this.$refs.scoreForm.resetFields();\r\n        this.$refs.upload.clearFiles();\r\n        this.formData.fileList = [];\r\n        this.selectedtNode = [];\r\n        this.roomOptions = [];\r\n        this.roomValue = '';\r\n        this.formData.score.global_score = 0;\r\n        this.formData.score.bed_score = 0;\r\n        this.formData.score.building_score = 0;\r\n        this.formData.score.indoor_score = 0;\r\n        this.hideUpload = false\r\n      },\r\n      // 三级菜单触发方法\r\n      async bdChange(value) {\r\n        this.loading = true\r\n        const { data } = await listByBId(value[value.length - 1])\r\n        this.roomOptions = this.formatData(data)\r\n        console.log(this.roomOptions)\r\n        this.loading = false\r\n      },\r\n      // 图片上传相关方法\r\n      handleImgChange(file,fileList) {\r\n        this.hideUpload = fileList.length >= this.limit; \r\n        this.formData.fileList = fileList;\r\n      },\r\n      // 图片删除\r\n      handleRemove(file) {\r\n        this.formData.fileList = [];\r\n        this.hideUpload = false\r\n      },\r\n      // 图片预览\r\n      handlePictureCardPreview(file) {\r\n        this.dialogImageUrl = file.url;\r\n        this.dialogVisible = true;\r\n      },\r\n      // 图片下载\r\n      handleDownload(file) {\r\n        console.log(file);\r\n        console.log(this.roomValue)\r\n      },\r\n      // 格式化数据\r\n      formatData(list) {\r\n        return list.map(item => {\r\n          const node = {\r\n            value: item.id,\r\n            label: item.number || item.name\r\n          };\r\n          // 仅当存在子节点且为数组时，递归格式化子节点\r\n          if (Array.isArray(item.children) && item.children.length > 0) {\r\n            node.children = this.formatData(item.children);\r\n          }\r\n\r\n          return node;\r\n        });\r\n      },\r\n      async listData() {\r\n        this.loading = true\r\n        const { data } = await list()\r\n        console.log(this.formatData(data))\r\n        this.bdOptions = this.formatData(data)\r\n        this.loading = false\r\n      }\r\n    },\r\n    created() {\r\n      this.listData()\r\n    }\r\n  }\r\n</script>\r\n\r\n<style scoped>\r\n  .table {\r\n    padding: 10px;\r\n    display: flex;\r\n  }\r\n\r\n  .score_table {\r\n    flex: 1;\r\n    margin-left: 5%;\r\n  }\r\n\r\n  .img_box {\r\n    flex: 2\r\n  }\r\n\r\n  .router-container {\r\n    height: 100%;\r\n  }\r\n\r\n  .room_selector {\r\n    margin-bottom: 8%;\r\n  }\r\n\r\n  .el-rate {\r\n    line-height: 2.5;\r\n    /* 重置行高 */\r\n    vertical-align: middle;\r\n    /* 垂直对齐 */\r\n  }\r\n\r\n  .el-button {\r\n    margin-top: 5%;\r\n  }\r\n\r\n  /* 隐藏上传按钮 */\r\n  ::v-deep .hide-upload .el-upload--picture-card {\r\n    display: none !important;\r\n  }\r\n</style>"]}]}