<<<<<<< HEAD
var inherits = require('inherits');
=======
'use strict';

const inherits = require('inherits');
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07

function Reporter(options) {
  this._reporterState = {
    obj: null,
    path: [],
    options: options || {},
    errors: []
  };
}
exports.Reporter = Reporter;

Reporter.prototype.isError = function isError(obj) {
  return obj instanceof ReporterError;
};

Reporter.prototype.save = function save() {
<<<<<<< HEAD
  var state = this._reporterState;
=======
  const state = this._reporterState;
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07

  return { obj: state.obj, pathLen: state.path.length };
};

Reporter.prototype.restore = function restore(data) {
<<<<<<< HEAD
  var state = this._reporterState;
=======
  const state = this._reporterState;
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07

  state.obj = data.obj;
  state.path = state.path.slice(0, data.pathLen);
};

Reporter.prototype.enterKey = function enterKey(key) {
  return this._reporterState.path.push(key);
};

Reporter.prototype.exitKey = function exitKey(index) {
<<<<<<< HEAD
  var state = this._reporterState;
=======
  const state = this._reporterState;
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07

  state.path = state.path.slice(0, index - 1);
};

Reporter.prototype.leaveKey = function leaveKey(index, key, value) {
<<<<<<< HEAD
  var state = this._reporterState;
=======
  const state = this._reporterState;
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07

  this.exitKey(index);
  if (state.obj !== null)
    state.obj[key] = value;
};

Reporter.prototype.path = function path() {
  return this._reporterState.path.join('/');
};

Reporter.prototype.enterObject = function enterObject() {
<<<<<<< HEAD
  var state = this._reporterState;

  var prev = state.obj;
=======
  const state = this._reporterState;

  const prev = state.obj;
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07
  state.obj = {};
  return prev;
};

Reporter.prototype.leaveObject = function leaveObject(prev) {
<<<<<<< HEAD
  var state = this._reporterState;

  var now = state.obj;
=======
  const state = this._reporterState;

  const now = state.obj;
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07
  state.obj = prev;
  return now;
};

Reporter.prototype.error = function error(msg) {
<<<<<<< HEAD
  var err;
  var state = this._reporterState;

  var inherited = msg instanceof ReporterError;
=======
  let err;
  const state = this._reporterState;

  const inherited = msg instanceof ReporterError;
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07
  if (inherited) {
    err = msg;
  } else {
    err = new ReporterError(state.path.map(function(elem) {
      return '[' + JSON.stringify(elem) + ']';
    }).join(''), msg.message || msg, msg.stack);
  }

  if (!state.options.partial)
    throw err;

  if (!inherited)
    state.errors.push(err);

  return err;
};

Reporter.prototype.wrapResult = function wrapResult(result) {
<<<<<<< HEAD
  var state = this._reporterState;
=======
  const state = this._reporterState;
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07
  if (!state.options.partial)
    return result;

  return {
    result: this.isError(result) ? null : result,
    errors: state.errors
  };
};

function ReporterError(path, msg) {
  this.path = path;
  this.rethrow(msg);
<<<<<<< HEAD
};
=======
}
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07
inherits(ReporterError, Error);

ReporterError.prototype.rethrow = function rethrow(msg) {
  this.message = msg + ' at: ' + (this.path || '(shallow)');
  if (Error.captureStackTrace)
    Error.captureStackTrace(this, ReporterError);

  if (!this.stack) {
    try {
      // IE only adds stack when thrown
      throw new Error(this.message);
    } catch (e) {
      this.stack = e.stack;
    }
  }
  return this;
};
