'use strict';

const fill = require('fill-range');
const utils = require('./utils');

const compile = (ast, options = {}) => {
<<<<<<< HEAD
<<<<<<< HEAD
  const walk = (node, parent = {}) => {
    const invalidBlock = utils.isInvalidBrace(parent);
    const invalidNode = node.invalid === true && options.escapeInvalid === true;
    const invalid = invalidBlock === true || invalidNode === true;
    const prefix = options.escapeInvalid === true ? '\\' : '';
=======
=======
>>>>>>> parent of 99ae58fb (修正代码，并打包成功上传部署到服务器（测试IP地址）)
  let walk = (node, parent = {}) => {
    let invalidBlock = utils.isInvalidBrace(parent);
    let invalidNode = node.invalid === true && options.escapeInvalid === true;
    let invalid = invalidBlock === true || invalidNode === true;
    let prefix = options.escapeInvalid === true ? '\\' : '';
<<<<<<< HEAD
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07
=======
>>>>>>> parent of 99ae58fb (修正代码，并打包成功上传部署到服务器（测试IP地址）)
    let output = '';

    if (node.isOpen === true) {
      return prefix + node.value;
    }
<<<<<<< HEAD
<<<<<<< HEAD

    if (node.isClose === true) {
      console.log('node.isClose', prefix, node.value);
=======
    if (node.isClose === true) {
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07
=======
    if (node.isClose === true) {
>>>>>>> parent of 99ae58fb (修正代码，并打包成功上传部署到服务器（测试IP地址）)
      return prefix + node.value;
    }

    if (node.type === 'open') {
<<<<<<< HEAD
<<<<<<< HEAD
      return invalid ? prefix + node.value : '(';
=======
      return invalid ? (prefix + node.value) : '(';
>>>>>>> parent of 99ae58fb (修正代码，并打包成功上传部署到服务器（测试IP地址）)
    }

    if (node.type === 'close') {
      return invalid ? (prefix + node.value) : ')';
    }

    if (node.type === 'comma') {
<<<<<<< HEAD
      return node.prev.type === 'comma' ? '' : invalid ? node.value : '|';
=======
      return invalid ? (prefix + node.value) : '(';
    }

    if (node.type === 'close') {
      return invalid ? (prefix + node.value) : ')';
    }

    if (node.type === 'comma') {
      return node.prev.type === 'comma' ? '' : (invalid ? node.value : '|');
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07
=======
      return node.prev.type === 'comma' ? '' : (invalid ? node.value : '|');
>>>>>>> parent of 99ae58fb (修正代码，并打包成功上传部署到服务器（测试IP地址）)
    }

    if (node.value) {
      return node.value;
    }

    if (node.nodes && node.ranges > 0) {
<<<<<<< HEAD
<<<<<<< HEAD
      const args = utils.reduce(node.nodes);
      const range = fill(...args, { ...options, wrap: false, toRegex: true, strictZeros: true });
=======
      let args = utils.reduce(node.nodes);
      let range = fill(...args, { ...options, wrap: false, toRegex: true });
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07
=======
      let args = utils.reduce(node.nodes);
      let range = fill(...args, { ...options, wrap: false, toRegex: true });
>>>>>>> parent of 99ae58fb (修正代码，并打包成功上传部署到服务器（测试IP地址）)

      if (range.length !== 0) {
        return args.length > 1 && range.length > 1 ? `(${range})` : range;
      }
    }

    if (node.nodes) {
<<<<<<< HEAD
<<<<<<< HEAD
      for (const child of node.nodes) {
        output += walk(child, node);
      }
    }

=======
      for (let child of node.nodes) {
        output += walk(child, node);
      }
    }
>>>>>>> e6897d3eee7dd92889ec4638067e9f9148ca1f07
=======
      for (let child of node.nodes) {
        output += walk(child, node);
      }
    }
>>>>>>> parent of 99ae58fb (修正代码，并打包成功上传部署到服务器（测试IP地址）)
    return output;
  };

  return walk(ast);
};

module.exports = compile;
